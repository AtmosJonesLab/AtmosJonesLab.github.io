<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Atmos Jones Lab</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  
  
</head>
<body>
  <header>
    <h1>Atmos Jones Lab</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="projects.html">Projects</a>
      <a href="team.html">Team</a>
    </nav>
  </header>
  <section class="hero">
    <h2>Urban Tree Ecophysiology Network</h2>
    <p>
     Data from a sugar maple located on Georgetown's campus in Washington, D.C. This tree is part of the Urban Trees Ecophysiology Network (UTEN), a network of researchers aiming to understand the urban trees response to climate change.
     The data is collected using a variety of sensors.
    </p>

  </section>
  <h2>Graphs</h2>

  <div class="graph-grid">
    <canvas id='temperatureChart' ></canvas>
    <canvas id='humidityChart' ></canvas>
  </div>
  <div class="graph-grid">
    <canvas id='pdendrochart' ></canvas>
    <canvas id='LDchart'></canvas>
  </div>
  <div class="graph-grid">
    <canvas id='batteryChart' ></canvas>
    <canvas id="batteryPercent"></canvas>
  </div>
     
  
 
    <h2>Raw Sensor Readings</h2>
    <table border="1" id="sensor-table">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Humidity</th>
          <th>Temperature</th>
          <th>Point Dendrometer</th>
          <th>LD</th>
          <th>Battery State</th>
          <th>Battery Voltage</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    
  

      <script>
    
    // Fetch data from Google Sheets API
//     API_KEY=AIzaSyBWq6_OOSDWjRS5j5Oco-TRAFtZRGMnwPA
//     SHEET_ID=1ik-hGF90uWHn2UCbzIJIQO_qhCTvhT1YTB4KH1C9-xQ

    const API_KEY = 'AIzaSyBWq6_OOSDWjRS5j5Oco-TRAFtZRGMnwPA';
    const SHEET_ID = '1ik-hGF90uWHn2UCbzIJIQO_qhCTvhT1YTB4KH1C9-xQ';
    const RANGE = 'alldata!A2:D';

    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;

   

    fetch('data.json')
      .then(response => response.json())
      .then(data => {
        const rows = data.values;


        // Step 1: Group by timestamp
        const groupedData = {};
        rows.forEach(([type, epochtime, timestamp, value]) => {
          if (!groupedData[epochtime]) {
            groupedData[epochtime] = {};
          }
          groupedData[epochtime][type.toLowerCase()] = value;
        });

        // Step 2: Render HTML Table
        const tbody = document.querySelector('#sensor-table tbody');
        for (const [epochtime, sensors] of Object.entries(groupedData)) {
          const tr = document.createElement('tr');

          const tdTime = document.createElement('td');
          tdTime.textContent = new Date(epochtime *1000).toLocaleString();
          tr.appendChild(tdTime);

          const columns = [
            'humidity',
            'temperature',
            'point dendrometer',
            'ld',
            'battery state',
            'battery voltage'
          ];

          columns.forEach(col => {
            const td = document.createElement('td');
            td.textContent = sensors[col] || '-';
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        }
        
    const getDataByType = (type) => {
    const points = [];
    for (const [epochtime, sensors] of Object.entries(groupedData)) {
      if (sensors[type]) {
        const y = parseFloat(sensors[type]);
        if (!isNaN(y)) {
          points.push({ x: new Date(epochtime*1000), y });
        }
      }
    }
    return points.sort((a, b) => a.x - b.x); // sort by time
  };

  


  const drawChart = (canvasId, label, data, color, useGradient = false) => {
          const canvas = document.getElementById(canvasId);
          const ctx = canvas.getContext('2d');

          let strokeStyle = color;

          if (useGradient) {
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#ef4444'); // red
            gradient.addColorStop(1, '#3b82f6'); // blue
            strokeStyle = gradient;
          }

          new Chart(canvas, {
            type: 'line',
            data: {
              datasets: [{
                label,
                data,
                borderColor: strokeStyle,
                backgroundColor: strokeStyle,
                fill: false,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: strokeStyle
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  type: 'time',
                  time: {
                    unit: 'day', // instead of 'minute'
                    displayFormats: {
                      day: 'MMM d, HH:mm' // or 'MMM d, yyyy' if you don’t want time
                    }
                  },
                  ticks: {
                    maxRotation: 0,
                    autoSkip: true,
                    font: { size: 12 }
                  },
                  title: {
                    display: true,
                    text: 'Time',
                    font: { size: 16 }
                  }
                }
                },
                y: {
                  beginAtZero: false,
                  title: { display: true, text: label }
                }
              },
              plugins: {
                title: {
                  display: true,
                  text: label,
                  font: {
                    size: 30,
                    weight: 'bold'
                  },
                  padding: { top: 10, bottom: 10 }
                },
                legend: {
                  display: false // You can still use the title as the chart header
                }
              }
          });
        };

        const drawBatteryChart = (canvasId, latestVoltage, maxVoltage = 4.5) => {
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');
  const percent = Math.min(latestVoltage / maxVoltage, 1);
  const color = percent > 0.75 ? '#22c55e' : percent > 0.5 ? '#facc15' : '#ef4444';

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Battery', 'Remaining'],
      datasets: [{
        data: [percent * 100, 100 - percent * 100],
        backgroundColor: [color, '#e5e7eb'],
        borderWidth: 0
      }]
    },
    options: {
      cutout: '70%',
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: context => `${context.label}: ${context.raw.toFixed(1)}%`
          }
        },
        title: {
          display: true,
          text: `Battery: ${(latestVoltage).toFixed(2)}V`,
          font: { size: 18 }
        }
      }
    }
  });
};

        // Draw battery chart
        const latestBatteryVoltage = parseFloat(getDataByType("battery voltage").slice(-1)[0]?.y || 0);
        drawBatteryChart('batteryPercent', latestBatteryVoltage);
        
  

  // Draw temperature and humidity charts

        drawChart('temperatureChart', "Temperature (ºC)", getDataByType("temperature"), "#f97316", true);
        drawChart('humidityChart', "Humidity (%)", getDataByType("humidity"), "#0ea5e9", true);
        drawChart('pdendrochart', "Point Dendrometer (µm)", getDataByType("point dendrometer"), "#a855f7");
        drawChart('LDchart', "LD", getDataByType("ld"), "#facc15");
        drawChart('batteryChart', "Battery Voltage", getDataByType("battery voltage"), "#22c55e");
  })
    .catch(error => {
      console.error('Error fetching data:', error);
  
  });
</script>

</body>
</html>