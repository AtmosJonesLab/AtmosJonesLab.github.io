<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Atmos Jones Lab</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  
  
</head>
<body>
  <header>
    <h1>Atmos Jones Lab</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="projects.html">Projects</a>
      <a href="team.html">Team</a>
    </nav>
  </header>
  <section class="hero">
    <h2>Urban Tree Ecophysiology Network</h2>
    <p>
     Data from a sugar maple located on Georgetown's campus in Washington, D.C. This tree is part of the Urban Trees Ecophysiology Network (UTEN), a network of researchers aiming to understand the urban trees response to climate change.
     The data is collected using a variety of sensors, including two types of dendrometers, and humidity and temperature sensors.
    </p>

  </section>

      <canvas id='temperatureChart' width="300" height="150"></canvas>
    
      <canvas id='humidityChart' width="300" height="150"></canvas>
    
      <canvas id='pdendrochart' width="300" height="150"></canvas>

      <canvas id='LDchart' width="300" height="150"></canvas>

      <canvas id='batteryChart' width="300" height="150"></canvas>
  
 
    <h2>Sensor Readings</h2>
    <table border="1" id="sensor-table">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Humidity</th>
          <th>Temperature</th>
          <th>Point Dendrometer</th>
          <th>LD</th>
          <th>Battery State</th>
          <th>Battery Voltage</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    
     
   
   
  <script>
    // Fetch data from Google Sheets API
    const API_KEY = 'AIzaSyBWq6_OOSDWjRS5j5Oco-TRAFtZRGMnwPA'; // Replace with your actual API key
    const SHEET_ID = '1ik-hGF90uWHn2UCbzIJIQO_qhCTvhT1YTB4KH1C9-xQ'; // Replace with your spreadsheet ID
    const RANGE = 'alldata!A2:D'; // Adjust range as needed

    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
    // https://sheets.googleapis.com/v4/spreadsheets/1ik-hGF90uWHn2UCbzIJIQO_qhCTvhT1YTB4KH1C9-xQ/values/unsorteddata!A2:C?key=AIzaSyBWq6_OOSDWjRS5j5Oco-TRAFtZRGMnwPA

    fetch(url)
      .then(response => response.json())
      .then(data => {
        const rows = data.values;


        // Step 1: Group by timestamp
        const groupedData = {};
        rows.forEach(([type, epochtime, timestamp, value]) => {
          if (!groupedData[epochtime]) {
            groupedData[epochtime] = {};
          }
          groupedData[epochtime][type.toLowerCase()] = value;
        });

        // Step 2: Render HTML Table
        const tbody = document.querySelector('#sensor-table tbody');
        for (const [epochtime, sensors] of Object.entries(groupedData)) {
          const tr = document.createElement('tr');

          const tdTime = document.createElement('td');
          tdTime.textContent = epochtime;
          tr.appendChild(tdTime);

          const columns = [
            'humidity',
            'temperature',
            'point dendrometer',
            'ld',
            'battery state',
            'battery voltage'
          ];

          columns.forEach(col => {
            const td = document.createElement('td');
            td.textContent = sensors[col] || '-';
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        }
        
    const getDataByType = (type) => {
    const points = [];
    for (const [epochtime, sensors] of Object.entries(groupedData)) {
      if (sensors[type]) {
        const y = parseFloat(sensors[type]);
        if (!isNaN(y)) {
          points.push({ x: new Date(epochtime*1000), y });
        }
      }
    }
    return points.sort((a, b) => a.x - b.x); // sort by time
  };


  const drawChart = (canvasId, label, data, color) => {
    new Chart(document.getElementById(canvasId), {
      type: 'line',
      data: {
        datasets: [{
          label,
          data,
          borderColor: color,
          fill: false,
          tension: 0.3,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'time', // Use the time scale
            time: {
              unit: 'minute', // Adjust the unit (e.g., 'minute', 'hour', 'day') based on your data
              displayFormats: {
                day: 'MMM DD, YYYY HH:mm', // Format for x-axis labels
              }
            },
            title: {display: true, text: 'Time'}
          },
          y: {
            beginAtZero: false,
            title: { display: true, text: label }
          }
        },
        plugins: {
          legend: { position: 'top' }
        }
      }
    });
  };

  // Draw temperature and humidity charts
  console.log(getDataByType("temperature")[0]);
  console.log(getDataByType("humidity"));

  drawChart('temperatureChart', "Temperature (ÂºC)", getDataByType("temperature"), "#f97316");
  drawChart('humidityChart', "Humidity (%)", getDataByType("humidity"), "#0ea5e9");
  drawChart('pdendrochart', "Point Dendro (um)", getDataByType("point dendrometer"), "#0ea5e9");
  drawChart('LDchart', "LD", getDataByType("ld"), "#0ea5e9");
  drawChart('batteryChart', "Battery Voltage", getDataByType("battery voltage"), "#0ea5e9");
  })
    .catch(error => {
      console.error('Error fetching data:', error);
  
  });
</script>

</body>
</html>