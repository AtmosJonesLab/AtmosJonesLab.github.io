<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Atmos Jones Lab</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  
  
</head>
<body>
  <header>
    <h1>Atmos Jones Lab</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="projects.html">Projects</a>
      <a href="team.html">Team</a>
    </nav>
  </header>
  <section class="hero">
    <h2>Urban Tree Ecophysiology Network</h2>
    <p>
     Data from a sugar maple located on Georgetown's campus in Washington, D.C. This tree is part of the Urban Trees Ecophysiology Network (UTEN), a network of researchers aiming to understand the urban trees response to climate change.
     The data is collected using a variety of sensors.
    </p>

  </section>
  <h2>Graphs</h2>

  <div class="graph-grid">
    <div class="chart-wrapper" onclick="toggleExpand(this)">
      <button class="close-btn" onclick="event.stopPropagation(); this.parentElement.classList.remove('expanded')">✕</button>
      <canvas id="temperatureChart"></canvas>
    </div>
    <div class="chart-wrapper" onclick="toggleExpand(this)">
      <button class="close-btn" onclick="event.stopPropagation(); this.parentElement.classList.remove('expanded')">✕</button>
      <canvas id="humidityChart"></canvas>
    </div>
  </div>

  <div class="graph-grid">
    <div class="chart-wrapper" onclick="toggleExpand(this)">
      <button class="close-btn" onclick="event.stopPropagation(); this.parentElement.classList.remove('expanded')">✕</button>
      <canvas id='pdendrochart' ></canvas>
    </div>
    <div class="chart-wrapper" onclick="toggleExpand(this)">
      <button class="close-btn" onclick="event.stopPropagation(); this.parentElement.classList.remove('expanded')">✕</button>
      <canvas id='LDchart'></canvas>
    </div>
  </div>

  <div class="graph-grid">
    
    <div class="battery-charts-row">
      <div class="chart-wrapper" onclick="toggleExpand(this)">
        <button class="close-btn" onclick="event.stopPropagation(); this.parentElement.classList.remove('expanded')">✕</button>
        <canvas id="batteryChart"></canvas>
      </div>
      <div class="battery-percent-wrapper">
        <canvas id="batteryPercent" width="200" height="200"></canvas>
      </div>
    </div>
  </div>
     

  <script>
    function toggleExpand(wrapper) {
      // Close any other expanded chart
      document.querySelectorAll('.chart-wrapper.expanded').forEach(el => {
        if (el !== wrapper) el.classList.remove('expanded');
      });
      // Toggle this one
      wrapper.classList.toggle('expanded');
    }
  
    // Optional: click outside to close
    document.addEventListener('click', function(e) {
      const expanded = document.querySelector('.chart-wrapper.expanded');
      if (expanded && !expanded.contains(e.target)) {
        expanded.classList.remove('expanded');
      }
    });
    
  </script>



  <section id="weather-section">
    <h2 class="section-title">Hoya Harvest Weather Station</h2>
  
    <div class="chart-grid" id="weatherCards">
      <!-- Weather cards injected by JavaScript -->
    </div>
  
    <p class="footer" id="weatherFooter"></p>
  </section>
  


 
    <h2>Raw Sensor Readings</h2>
    <table border="1" id="sensor-table">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Humidity</th>
          <th>Temperature</th>
          <th>Point Dendrometer</th>
          <th>LD</th>
          <th>Battery State</th>
          <th>Battery Voltage</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    
   

    
    
    
    <script>
      fetch('https://script.google.com/macros/s/AKfycbxRrH8FygxXP57qg0hW-aaCNlt7TJHNqb-hG66Fy9MnQ_0DI31wHF-VFtKFyKHFoPY/exec')
        .then(res => res.json())
        .then(data => {
          const w = data.davis_current_observation;
        
    
          const cardData = [
            { label: "Temperature", value: `${data.temp_f}°F (${data.temp_c}°C)` },
            { label: "Humidity", value: `${data.relative_humidity}%` },
            { label: "Pressure", value: `${data.pressure_mb} mb` },
            { label: "Wind", value: `${data.wind_mph} mph (${w.wind_dir})` },
            { label: "Wind Chill", value: `${data.windchill_f}°F` },
            { label: "Heat Index", value: `${data.heat_index_f}°F` },
            { label: "Dew Point", value: `${data.dewpoint_f}°F` },
          ];
          const container = document.getElementById("weatherCards");
          cardData.forEach(item => {
            const div = document.createElement("div");
            div.className = "card";
            div.innerHTML = `<h4>${item.label}</h4><p>${item.value}</p>`;
            container.appendChild(div);
          });

    
          // Footer
          document.getElementById("weatherFooter").textContent =
            `Data from Davis Instruments • Station: ${w.station_name} • Last updated: ${data.observation_time}`;
        })
        .catch(err => {
          console.error("Weather data error:", err);
          document.getElementById("weatherCards").innerHTML =
            `<div class="card"><h4>Error</h4><p>Could not load weather data.</p></div>`;
        });
    </script>
    
  



    <script>
      fetch('data.json')
        .then(response => response.json())
        .then(data => {
          const rows = data.values;

          // Step 1: Build separate arrays for each sensor type
          const sensorData = {
            "temperature": [],
            "humidity": [],
            "point dendrometer": [],
            "ld": [],
            "battery state": [],
            "battery voltage": []
          };

          const tableRowsByTimestamp = {};

          rows.forEach(([type, epochtime, timestamp, value]) => {
            const key = type.toLowerCase();
            const numericValue = parseFloat(value);
            const time = new Date(parseInt(epochtime) * 1000);

            if (!isNaN(numericValue) && sensorData[key]) {
              sensorData[key].push({ x: time, y: numericValue });
            }

            // Build table rows by timestamp
            if (!tableRowsByTimestamp[epochtime]) {
              tableRowsByTimestamp[epochtime] = { time: time.toLocaleString() };
            }
            tableRowsByTimestamp[epochtime][key] = value;
          });
          // Sort all sensor data by timestamp
          for (const key in sensorData) {
            sensorData[key].sort((a, b) => a.x - b.x);
          }


          // Step 2: Render HTML Table
          const tbody = document.querySelector('#sensor-table tbody');
          for (const [epochtime, sensors] of Object.entries(tableRowsByTimestamp)) {
            const tr = document.createElement('tr');

            const tdTime = document.createElement('td');
            tdTime.textContent = sensors.time;
            tr.appendChild(tdTime);

            const columns = [
              'humidity',
              'temperature',
              'point dendrometer',
              'ld',
              'battery state',
              'battery voltage'
            ];

            columns.forEach(col => {
              const td = document.createElement('td');
              td.textContent = sensors[col] || '-';
              tr.appendChild(td);
            });

            tbody.appendChild(tr);
          }
    
          // Step 4: Chart Drawing
          const drawChart = (canvasId, label, data, color, useGradient = false) => {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
    
            let strokeStyle = color;
            if (useGradient) {
              const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
              gradient.addColorStop(0, '#ef4444');
              gradient.addColorStop(1, '#3b82f6');
              strokeStyle = gradient;
            }
    
            new Chart(canvas, {
              type: 'line',
              data: {
                datasets: [{
                  label,
                  data,
                  borderColor: strokeStyle,
                  backgroundColor: strokeStyle,
                  fill: false,
                  tension: 0.4,
                  pointRadius: 2,
                  pointBackgroundColor: strokeStyle
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  x: {
                    type: 'time',
                    time: {
                      unit: 'day',
                      displayFormats: {
                        day: 'MMM d, HH:mm'
                      }
                    },
                    ticks: {
                      maxRotation: 0,
                      autoSkip: true,
                      font: { size: 12 }
                    },
                    title: {
                      display: true,
                      text: 'Time',
                      font: { size: 16 }
                    }
                  },
                  y: {
                    beginAtZero: false,
                    title: { display: true, text: label }
                  }
                },
                plugins: {
                  title: {
                    display: true,
                    text: label,
                    font: {
                      size: 30,
                      weight: 'bold'
                    },
                    padding: { top: 10, bottom: 10 }
                  },
                  legend: {
                    display: false
                  }
                }
              }
            });
          };
    
          const drawBatteryChart = (canvasId, latestVoltage, maxVoltage = 4.5) => {
            if (maxVoltage < latestVoltage){
              maxVoltage = latestVoltage;
            }
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const percent = Math.min(latestVoltage / maxVoltage, 1);
            const color = percent > 0.75 ? '#22c55e' : percent > 0.5 ? '#facc15' : '#ef4444';
    
            new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: ['Battery', 'Remaining'],
                datasets: [{
                  data: [percent * 100, 100 - percent * 100],
                  backgroundColor: [color, '#e5e7eb'],
                  borderWidth: 0
                }]
              },
              options: {
                responsive: false, // <- important!
                maintainAspectRatio: false, // <- allows fixed dimensions
                cutout: '70%',
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      label: context => `${context.label}: ${context.raw.toFixed(1)}%`
                    }
                  },
                  title: {
                    display: true,
                    text: `Battery: ${latestVoltage.toFixed(2)}V`,
                    font: { size: 18 }
                  }
                }
              }
            });
          };
    
          // Step 5: Draw All Charts
          drawBatteryChart('batteryPercent', parseFloat(sensorData["battery voltage"].slice(-1)[0]?.y || 0));

          drawChart('temperatureChart', "Temperature (ºC)", sensorData["temperature"], "#f97316", true);
          drawChart('humidityChart', "Humidity (%)", sensorData["humidity"], "#0ea5e9", true);
          drawChart('pdendrochart', "Point Dendrometer (µm)", sensorData["point dendrometer"], "#a855f7");
          drawChart('LDchart', "LD", sensorData["ld"], "#facc15");
          drawChart('batteryChart', "Battery Voltage", sensorData["battery voltage"], "#22c55e");
        })
        .catch(error => {
          console.error('❌ Error fetching or processing data:', error);
        });
    </script>
    

</body>
</html>